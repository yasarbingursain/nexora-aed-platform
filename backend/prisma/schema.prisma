// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organizations (Multi-tenancy)
model Organization {
  id                String              @id @default(cuid())
  name              String
  domain            String?             @unique
  subscriptionTier  String              @default("free") // free, foundation, professional, enterprise
  status            OrganizationStatus  @default(ACTIVE)
  maxUsers          Int                 @default(5)
  maxIdentities     Int                 @default(100)
  settings          String              @default("{}") // JSON as string for SQLite
  suspendedAt       DateTime?
  suspensionReason  String?
  deletedAt         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // TRIAL & PAYMENT FIELDS
  trialEndsAt          DateTime?           // 7 days from creation for trial
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?
  paymentStatus        String              @default("trial") // trial, active, past_due, canceled

  // Relations
  users             User[]
  identities        Identity[]
  threats           Threat[]
  incidents         Incident[]
  auditLogs         AuditLog[]
  apiKeys           ApiKey[]
  playbooks         Playbook[]
  complianceReports ComplianceReport[]
  baselines         Baseline[]
  observations      Observation[]
  actions           Action[]
  securityEvents    SecurityEvent[]
  adminActions      AdminAuditLog[]
  evidenceLogs      EvidenceLog[]

  @@map("organizations")
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// Users
model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  fullName       String
  role           String    @default("viewer") // admin, analyst, viewer, auditor, super_admin
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  mfaEnabled     Boolean   @default(false)
  mfaSecret      String?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // SECURITY FIX: CWE-307 - Account Lockout Fields
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?
  lastFailedLogin     DateTime?
  
  // Password Reset Fields
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refreshTokens  RefreshToken[]
  auditLogs      AuditLog[]
  sessions       UserSession[]
  adminActions   AdminAuditLog[] @relation("AdminActions")
  securityEvents SecurityEvent[]

  @@index([lockedUntil])
  @@index([email, lockedUntil])
  @@map("users")
}

// Refresh Tokens
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// User Sessions
model UserSession {
  id              String    @id @default(cuid())
  userId          String
  sessionToken    String    @unique
  tokenVersion    Int       @default(0)
  deviceInfo      String?
  ipAddress       String
  userAgent       String?
  isActive        Boolean   @default(true)
  expiresAt       DateTime
  lastActivity    DateTime  @default(now())
  lastRefreshedAt DateTime?
  createdAt       DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId, isActive])
  @@index([tokenVersion])
  @@map("user_sessions")
}

// API Keys
model ApiKey {
  id             String   @id @default(cuid())
  name           String
  keyHash        String   @unique
  permissions    String   @default("") // array of permissions as comma-separated
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean  @default(true)
  organizationId String
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// Identities (NHI - Non-Human Identities)
model Identity {
  id               String    @id @default(cuid())
  name             String
  type             String    // api_key, service_account, ssh_key, certificate, ai_agent, bot
  provider         String    // aws, azure, gcp, github, gitlab, kubernetes, custom
  externalId       String?   // provider-specific ID
  status           String    @default("active") // active, inactive, compromised, quarantined
  riskLevel        String    @default("low") // low, medium, high, critical
  owner            String?   // email of responsible person
  description      String?
  tags             String    @default("")
  credentials      String    @default("{}") // encrypted credential data as JSON string
  metadata         String    @default("{}")
  lastSeenAt       DateTime?
  lastRotatedAt    DateTime?
  rotationInterval Int?      // days
  organizationId   String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  activities       IdentityActivity[]
  threats          Threat[]
  actions          Action[]
  baselines        Baseline[]
  observations     Observation[]

  @@map("identities")
}

// Identity Activities (behavioral data)
model IdentityActivity {
  id         String   @id @default(cuid())
  identityId String
  activity   String   // login, api_call, file_access, etc.
  source     String   // ip_address, user_agent, etc.
  metadata   String   @default("{}")
  timestamp  DateTime @default(now())

  // Relations
  identity Identity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@map("identity_activities")
}

// Behavioral Baselines
model Baseline {
  id               String   @id @default(cuid())
  identityId       String
  behaviorType     String   // login_pattern, api_usage, location, etc.
  baselineData     String   @default("{}") // statistical baseline data as JSON string
  confidence       Float    @default(0.0)
  lastUpdated      DateTime @default(now())
  organizationId   String

  // Relations
  identity     Identity     @relation(fields: [identityId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("baselines")
}

// Real-time Observations
model Observation {
  id             String   @id @default(cuid())
  identityId     String
  observationType String   // behavior, anomaly, threat_indicator
  data           String   @default("{}")
  anomalyScore   Float?
  timestamp      DateTime @default(now())
  organizationId String

  // Relations
  identity     Identity     @relation(fields: [identityId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("observations")
}

// Threats
model Threat {
  id             String    @id @default(cuid())
  title          String
  description    String
  severity       String    @default("medium") // low, medium, high, critical
  status         String    @default("open") // open, investigating, resolved, false_positive
  category       String    // credential_abuse, privilege_escalation, data_exfiltration, etc.
  identityId     String?
  sourceIp       String?
  indicators     String    @default("[]") // IOCs as JSON string
  evidence       String    @default("{}")
  mitreTactics   String    @default("") // MITRE ATT&CK tactics as comma-separated
  mitreId        String?   // MITRE ATT&CK technique ID
  assignedTo     String?   // user email
  resolvedAt     DateTime?
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  identity     Identity?    @relation(fields: [identityId], references: [id])
  incidents    Incident[]
  actions      Action[]

  @@map("threats")
}

// Incidents (grouped threats)
model Incident {
  id             String   @id @default(cuid())
  title          String
  description    String
  severity       String   @default("medium")
  status         String   @default("open")
  assignedTo     String?
  dossier        String   @default("{}")
  compliance     String   @default("{}")
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  threats      Threat[]

  @@map("incidents")
}

// Remediation Actions
model Action {
  id             String    @id @default(cuid())
  type           String    // rotate, quarantine, deception, rollback, notify
  status         String    @default("pending") // pending, running, completed, failed
  identityId     String?
  threatId       String?
  playbookId     String?
  parameters     String    @default("{}")
  result         String?
  rollbackPlan   String?
  executedAt     DateTime?
  completedAt    DateTime?
  organizationId String
  createdAt      DateTime  @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  identity     Identity?    @relation(fields: [identityId], references: [id])
  threat       Threat?      @relation(fields: [threatId], references: [id])
  playbook     Playbook?    @relation(fields: [playbookId], references: [id])

  @@map("actions")
}

// Remediation Playbooks
model Playbook {
  id             String   @id @default(cuid())
  name           String
  description    String?
  trigger        String   @default("{}") // trigger conditions as JSON string
  actions        String   @default("[]") // array of actions to execute as JSON string
  isActive       Boolean  @default(true)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   Action[]

  @@map("playbooks")
}

// Compliance Reports
model ComplianceReport {
  id             String    @id @default(cuid())
  framework      String    // soc2, iso27001, pci_dss, hipaa, etc.
  reportType     String    // audit, assessment, evidence
  status         String    @default("generating") // generating, completed, failed
  data           String?
  filePath       String?
  generatedAt    DateTime?
  organizationId String
  createdAt      DateTime  @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("compliance_reports")
}

// Audit Logs - Enhanced for Compliance (SOC2, GDPR, HIPAA, ISO 27001)
model AuditLog {
  id             String   @id @default(cuid())
  
  // Event Information
  event          String   // Event name (e.g., "user_login", "data_export")
  entityType     String   // Type of entity affected (e.g., "user", "threat", "identity")
  entityId       String   // ID of affected entity
  action         String   // Action performed (create, read, update, delete, execute, access, export)
  
  // Actor Information
  userId         String?
  organizationId String
  
  // Context Information
  ipAddress      String?
  userAgent      String?
  metadata       String?  // JSON string with additional context
  
  // Change Tracking
  changes        String?  // JSON string with before/after values
  
  // Result Information
  result         String?  // success, failure, partial
  errorMessage   String?
  
  // Security Classification
  severity       String   @default("medium") // low, medium, high, critical
  
  // Legacy fields for backward compatibility
  resource       String?  // Deprecated - use entityType
  requestBody    String?
  responseStatus Int?
  duration       Int?     // milliseconds
  
  timestamp      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])

  @@index([organizationId, timestamp])
  @@index([userId, timestamp])
  @@index([entityType, timestamp])
  @@index([severity, timestamp])
  @@map("audit_logs")
}

// System Uptime Metrics (for SLO tracking)
model SystemUptimeMetric {
  id             String   @id @default(cuid())
  serviceName    String
  status         String   // up, down, degraded
  responseTimeMs Int?
  errorRate      Float?
  metadata       String   @default("{}") // JSON as string
  timestamp      DateTime @default(now())

  @@map("system_uptime_metrics")
}

// Vendor Risk Assessments
model VendorAssessment {
  id                    String    @id @default(cuid())
  organizationId        String
  vendorName            String
  vendorDomain          String?
  vendorType            String    // saas, infrastructure, security, data_processor, consultant, other
  riskLevel             String    // low, medium, high, critical
  riskScore             Float?
  lastAssessedAt        DateTime
  nextAssessmentDue     DateTime
  soc2Certified         Boolean   @default(false)
  iso27001Certified     Boolean   @default(false)
  gdprCompliant         Boolean   @default(false)
  hipaaCompliant        Boolean   @default(false)
  questionnaireCompleted Boolean  @default(false)
  questionnaireScore    Float?
  questionnaireDate     DateTime?
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  dataProcessed         String?   // JSON array as string
  dataLocation          String?   // JSON array as string
  status                String    @default("active") // active, inactive, under_review, terminated
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([organizationId, vendorName])
  @@map("vendor_assessments")
}

// DORA ICT Incidents
model DoraIctIncident {
  id                     String    @id @default(cuid())
  organizationId         String
  incidentType           String    // cyber_attack, system_failure, data_loss, service_disruption, etc.
  severity               String    // major, significant, minor
  detectedAt             DateTime
  reportedToAuthorityAt  DateTime?
  resolvedAt             DateTime?
  servicesAffected       String?   // JSON array as string
  usersAffected          Int?
  financialImpact        Float?
  dataCompromised        Boolean   @default(false)
  rootCause              String?
  contributingFactors    String?   // JSON array as string
  immediateActions       String?
  remediationPlan        String?
  lessonsLearned         String?
  authorityNotified      Boolean   @default(false)
  notificationMethod     String?
  reportReference        String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@map("dora_ict_incidents")
}

// Admin Audit Logs
model AdminAuditLog {
  id             String        @id @default(cuid())
  adminId        String
  action         String        // CREATE_ORGANIZATION, UPDATE_ORGANIZATION, SUSPEND_USER, etc.
  resourceType   String        // organization, user, system
  resourceId     String
  details        String        @default("{}") // JSON as string
  ipAddress      String?
  userAgent      String?
  organizationId String?
  createdAt      DateTime      @default(now())

  // Relations
  admin          User          @relation("AdminActions", fields: [adminId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@map("admin_audit_logs")
}

// Security Events
model SecurityEvent {
  id             String        @id @default(cuid())
  type           String        // failed_login, suspicious_activity, unauthorized_access, etc.
  severity       String        // low, medium, high, critical
  description    String
  sourceIp       String?
  userId         String?
  organizationId String?
  details        String        @default("{}") // JSON as string
  resolved       Boolean       @default(false)
  resolvedBy     String?
  resolvedAt     DateTime?
  createdAt      DateTime      @default(now())

  // Relations
  user           User?         @relation(fields: [userId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@map("security_events")
}

// MalGenX Malware Samples
model MalwareSample {
  id                    String    @id @default(uuid())
  organizationId        String    @map("organization_id")
  submissionType        String    @map("submission_type")
  fileHashSha256        String?   @map("file_hash_sha256")
  fileHashMd5           String?   @map("file_hash_md5")
  fileHashSha1          String?   @map("file_hash_sha1")
  fileName              String?   @map("file_name")
  fileSize              BigInt?   @map("file_size_bytes")
  fileType              String?   @map("file_mime_type")
  url                   String?
  source                String?
  tags                  String[]
  priority              String    @default("normal")
  submittedBy           String?   @map("submitted_by")
  status                String    @default("queued")
  analysisStartedAt     DateTime? @map("analysis_started_at")
  analysisCompletedAt   DateTime? @map("analysis_completed_at")
  analysisDurationMs    Int?      @map("analysis_duration_ms")
  categoryUid           Int       @default(4) @map("category_uid")
  categoryName          String    @default("Security Finding") @map("category_name")
  classUid              Int       @default(4001) @map("class_uid")
  className             String    @default("Malware Finding") @map("class_name")
  typeUid               Int       @default(400101) @map("type_uid")
  typeName              String    @default("Malware Sample Analysis") @map("type_name")
  riskScore             Decimal?  @map("risk_score") @db.Decimal(5, 2)
  riskLevel             String?   @map("risk_level")
  confidenceScore       Decimal?  @map("confidence_score") @db.Decimal(3, 2)
  malwareFamily         String?   @map("malware_family")
  malwareCategory       String?   @map("malware_category")
  isMalicious           Boolean?  @map("is_malicious")
  falsePositive         Boolean   @default(false) @map("false_positive")
  mitreTactics          String[]  @map("mitre_tactics")
  mitreTechniques       String[]  @map("mitre_techniques")
  storageLocation       String?   @map("storage_location")
  retentionPolicy       String    @default("standard") @map("retention_policy")
  expiresAt             DateTime? @map("expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  iocs                  MalwareIoc[]

  @@map("malware_samples")
}

// MalGenX Extracted IOCs
model MalwareIoc {
  id                    String    @id @default(uuid())
  sampleId              String    @map("sample_id")
  organizationId        String    @map("organization_id")
  iocType               String    @map("ioc_type")
  iocValue              String    @map("ioc_value")
  extractionMethod      String    @map("extraction_method")
  context               String?
  isValidated           Boolean   @default(false) @map("is_validated")
  validationMethod      String?   @map("validation_method")
  threatIntelSources    String[]  @map("threat_intel_sources")
  reputationScore       Decimal?  @map("reputation_score") @db.Decimal(3, 2)
  isKnownMalicious      Boolean?  @map("is_known_malicious")
  countryCode           String?   @map("country_code")
  countryName           String?   @map("country_name")
  asn                   String?
  asnOrg                String?   @map("asn_org")
  firstSeen             DateTime  @default(now()) @map("first_seen")
  lastSeen              DateTime  @default(now()) @map("last_seen")
  tags                  String[]
  threatScore           Decimal?  @map("threat_score") @db.Decimal(3, 2)
  firstSeenAt           DateTime  @default(now()) @map("first_seen_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  sample                MalwareSample @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  @@unique([sampleId, iocType, iocValue], name: "unique_sample_ioc")
  @@map("malware_iocs")
}

// Threat Intelligence Ingestion Failures
model IngestionFailure {
  id                    String   @id @default(uuid())
  source                String
  errorMessage          String   @map("error_message")
  errorStack            String?  @map("error_stack")
  retryCount            Int      @default(0) @map("retry_count")
  createdAt             DateTime @default(now()) @map("created_at")

  @@map("ingestion_failures")
}

// OSINT Threat Events (OCSF 1.1.0 Compliant - from migration 060)
model ThreatEvent {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  
  // Core IOC Identity
  externalId            String    @unique @map("external_id")
  source                String
  indicatorType         String    @map("indicator_type")
  value                 String
  
  // OCSF Category/Class/Type
  categoryUid           Int       @default(3) @map("category_uid")
  categoryName          String    @default("Finding") @map("category_name")
  classUid              Int       @default(3001) @map("class_uid")
  className             String    @default("Threat Finding") @map("class_name")
  typeUid               Int       @default(300101) @map("type_uid")
  typeName              String    @default("OSINT Threat Finding") @map("type_name")
  
  // OCSF Activity & Status
  activityId            Int       @default(1) @map("activity_id")
  activityName          String    @default("Detected") @map("activity_name")
  severityId            Int       @map("severity_id")
  severity              String
  statusId              Int       @default(1) @map("status_id")
  status                String    @default("New")
  
  // Risk Assessment
  riskScore             Decimal   @map("risk_score") @db.Decimal(5, 2)
  riskLabel             String    @map("risk_label")
  confidence            Decimal?  @db.Decimal(3, 2)
  
  // Threat Details
  description           String?
  sightings             Int       @default(1)
  tags                  String[]
  
  // Geolocation
  countryCode           String?   @map("country_code")
  countryName           String?   @map("country_name")
  city                  String?
  latitude              Float?
  longitude             Float?
  
  // Temporal Data
  firstSeen             DateTime  @map("first_seen")
  lastSeen              DateTime  @map("last_seen")
  expiresAt             DateTime? @map("expires_at")
  
  // OCSF Entity Fields (JSONB)
  actor                 Json?
  resource              Json?
  metadata              Json?
  findingInfo           Json?     @map("finding_info")
  observables           Json?
  
  // Multi-tenancy
  organizationId        String?   @map("organization_id")
  
  // Audit Fields
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("threat_events")
}

// NHITI (Non-Human Identity Threat Intelligence) Network
// Standards: STIX 2.1, TAXII 2.1, GDPR Article 25
model NhitiIndicator {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  
  // Privacy-Preserving Identifier
  indicatorHash       String    @unique @map("indicator_hash")
  
  // STIX 2.1 Indicator Type
  iocType             String    @map("ioc_type")
  
  // Threat Classification
  threatCategory      String    @map("threat_category")
  
  // Risk Assessment
  severity            String
  confidence          Decimal   @db.Decimal(3, 2)
  riskScore           Decimal   @default(0.0) @map("risk_score") @db.Decimal(5, 2)
  
  // K-Anonymity Tracking
  contributingOrgs    String[]  @default([]) @map("contributing_orgs")
  observationCount    Int       @default(1) @map("observation_count")
  
  // Differential Privacy
  epsilon             Decimal   @default(0.1) @db.Decimal(5, 3)
  noiseApplied        Boolean   @default(false) @map("noise_applied")
  
  // Temporal Data
  firstSeen           DateTime  @default(now()) @map("first_seen")
  lastSeen            DateTime  @default(now()) @map("last_seen")
  ttlHours            Int       @default(168) @map("ttl_hours")
  expiresAt           DateTime? @map("expires_at")
  
  // STIX 2.1 Extensions
  stixId              String?   @map("stix_id")
  stixVersion         String?   @default("2.1") @map("stix_version")
  pattern             String?
  patternType         String?   @default("stix") @map("pattern_type")
  
  // Metadata
  metadata            Json      @default("{}")
  
  // Audit Trail
  sharedAt            DateTime  @default(now()) @map("shared_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  @@map("nhiti_indicators")
}

model NhitiParticipation {
  id                        String   @id @default(dbgenerated("gen_random_uuid()"))
  
  // Anonymous Organization Identifier
  orgHash                   String   @unique @map("org_hash")
  
  // Participation Metrics
  indicatorsShared          Int      @default(0) @map("indicators_shared")
  indicatorsConsumed        Int      @default(0) @map("indicators_consumed")
  reputationScore           Decimal  @default(50.0) @map("reputation_score") @db.Decimal(5, 2)
  
  // Privacy Settings
  kThreshold                Int      @default(5) @map("k_threshold")
  epsilonBudget             Decimal  @default(0.1) @map("epsilon_budget") @db.Decimal(5, 3)
  enableDifferentialPrivacy Boolean  @default(true) @map("enable_differential_privacy")
  
  // Temporal
  joinedAt                  DateTime @default(now()) @map("joined_at")
  lastActive                DateTime @default(now()) @map("last_active")
  
  @@map("nhiti_participation")
}

model NhitiQueryLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()"))
  
  // Requester (hashed for privacy)
  requesterHash  String   @map("requester_hash")
  
  // Query Details
  queryType      String   @map("query_type")
  queryParams    Json     @default("{}") @map("query_params")
  resultsCount   Int      @default(0) @map("results_count")
  
  // Rate Limiting & Abuse Detection
  ipHash         String?  @map("ip_hash")
  userAgentHash  String?  @map("user_agent_hash")
  
  // Temporal
  queriedAt      DateTime @default(now()) @map("queried_at")
  expiresAt      DateTime @default(dbgenerated("(NOW() + INTERVAL '90 days')")) @map("expires_at")
  
  @@map("nhiti_query_log")
}

// Evidence Log - Tamper-proof audit trail with cryptographic hashing
model EvidenceLog {
  id               BigInt   @id @default(autoincrement())
  
  // Temporal
  ts               DateTime @default(now())
  
  // Organization Context
  organizationId   String   @map("organization_id")
  
  // Actor Information
  actor            String   // User ID or system identifier
  
  // Action Details
  action           String   // Action performed (e.g., "threat_created", "identity_modified")
  resourceType     String   @map("resource_type") // Type of resource (e.g., "threat", "identity")
  resourceId       String   @map("resource_id") // ID of the resource
  
  // Payload
  payload          Json     // Full event data
  
  // Cryptographic Chain
  prevHash         String?  @map("prev_hash") // Hash of previous record (blockchain-style)
  rowHash          String   @map("row_hash") // Hash of current record
  
  // Retention
  retentionUntil   DateTime @map("retention_until") // When this record can be deleted
  
  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, ts])
  @@index([resourceType, resourceId])
  @@index([actor])
  @@map("evidence_log")
}

// Identity Lineage - Track identity creation and modification history
model IdentityLineage {
  id               String   @id @default(cuid())
  identityId       String   @map("identity_id")
  parentIdentityId String?  @map("parent_identity_id")
  relationship     String   // created_from, cloned_from, rotated_from, delegated_from
  createdBy        String   @map("created_by")
  purpose          String
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  
  @@index([identityId])
  @@index([parentIdentityId])
  @@map("identity_lineage")
}

// Honey Tokens - Deception technology for threat detection
model HoneyToken {
  id                  String    @id @default(cuid())
  organizationId      String    @map("organization_id")
  type                String    // api_key, aws_credential, database_credential, etc.
  tokenHash           String    @unique @map("token_hash") // Hashed value for lookup
  name                String
  description         String?
  deploymentLocation  String    @map("deployment_location")
  status              String    @default("active") // active, triggered, expired, disabled
  triggerCount        Int       @default(0) @map("trigger_count")
  firstTriggeredAt    DateTime? @map("first_triggered_at")
  lastTriggeredAt     DateTime? @map("last_triggered_at")
  expiresAt           DateTime? @map("expires_at")
  metadata            Json      @default("{}")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  alerts              HoneyTokenAlert[]
  
  @@index([organizationId, status])
  @@index([tokenHash])
  @@map("honey_tokens")
}

// Honey Token Alerts - Track when honey tokens are triggered
model HoneyTokenAlert {
  id            String   @id @default(cuid())
  tokenId       String   @map("token_id")
  sourceIp      String   @map("source_ip")
  userAgent     String?  @map("user_agent")
  requestPath   String?  @map("request_path")
  requestMethod String?  @map("request_method")
  headers       Json     @default("{}")
  severity      String   // low, medium, high, critical
  metadata      Json     @default("{}")
  triggeredAt   DateTime @default(now()) @map("triggered_at")
  
  token         HoneyToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  
  @@index([tokenId])
  @@index([sourceIp])
  @@map("honey_token_alerts")
}

// Remediation Rollback - Track rollback data for remediation actions
model RemediationRollback {
  id           String    @id @default(cuid())
  actionId     String    @map("action_id")
  actionType   String    @map("action_type")
  target       String
  rollbackData Json      @map("rollback_data")
  status       String    @default("pending") // pending, completed, failed, expired
  expiresAt    DateTime  @map("expires_at")
  executedAt   DateTime? @map("executed_at")
  error        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  
  @@index([actionId])
  @@index([status])
  @@map("remediation_rollbacks")
}

// ML Predictions - Store ML model predictions for audit
model MLPrediction {
  id              String   @id @default(cuid())
  identityId      String   @map("identity_id")
  organizationId  String   @map("organization_id")
  modelVersion    String   @map("model_version")
  isAnomaly       Boolean  @map("is_anomaly")
  anomalyScore    Float    @map("anomaly_score")
  riskLevel       String   @map("risk_level")
  confidence      Float
  features        Json
  contributingFactors String[] @map("contributing_factors")
  explanation     Json?    // SHAP/LIME explanation data
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([identityId])
  @@index([organizationId, createdAt])
  @@index([isAnomaly])
  @@map("ml_predictions")
}

// Notifications - Persistent notification queue for users
model Notification {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")
  type           String    // security_alert, api_key_rotation, password_change, account_lockout, workflow_approval, system_notification
  severity       String    // low, medium, high, critical
  title          String
  message        String    @db.Text
  data           String?   @db.Text // JSON data
  actionUrl      String?   @map("action_url")
  read           Boolean   @default(false)
  readAt         DateTime? @map("read_at")
  expiresAt      DateTime? @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([organizationId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([severity])
  @@map("notifications")
}

// Forensic Timeline Events - Aggregated timeline for investigations
model ForensicTimelineEvent {
  id            String   @id @default(cuid())
  organizationId String  @map("organization_id")
  eventType     String   @map("event_type")
  category      String   // identity, threat, compliance, remediation, system
  severity      String
  title         String
  description   String
  actorId       String   @map("actor_id")
  actorType     String   @map("actor_type")
  targetId      String   @map("target_id")
  targetType    String   @map("target_type")
  sourceSystem  String   @map("source_system")
  evidenceHash  String?  @map("evidence_hash")
  mitreMapping  Json?    @map("mitre_mapping")
  metadata      Json     @default("{}")
  timestamp     DateTime
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([organizationId, timestamp])
  @@index([category])
  @@index([actorId])
  @@index([targetId])
  @@map("forensic_timeline_events")
}

// SIEM Configuration - Per-organization SIEM integration settings
model SiemConfiguration {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  organizationId  String    @map("organization_id")
  
  provider        String    // splunk, sentinel, elastic, qradar, syslog
  name            String
  description     String?
  
  enabled         Boolean   @default(false)
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  connectionConfig Json     @default("{}") @map("connection_config")
  format          String    @default("cef") // cef, leef, json, syslog
  
  batchSize       Int       @default(50) @map("batch_size")
  flushIntervalMs Int       @default(10000) @map("flush_interval_ms")
  
  severityFilter  String[]  @map("severity_filter")
  categoryFilter  String[]  @map("category_filter")
  
  lastSuccessfulSend DateTime? @map("last_successful_send")
  lastError       String?   @map("last_error")
  lastErrorAt     DateTime? @map("last_error_at")
  eventsSentTotal BigInt    @default(0) @map("events_sent_total")
  eventsFailedTotal BigInt  @default(0) @map("events_failed_total")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdBy       String?   @map("created_by")
  updatedBy       String?   @map("updated_by")
  
  @@unique([organizationId, provider, name], name: "unique_siem_provider_per_org")
  @@index([organizationId])
  @@index([provider])
  @@index([enabled])
  @@map("siem_configurations")
}

// SIEM Event Log - Audit and replay capability
model SiemEventLog {
  id              BigInt    @id @default(autoincrement())
  organizationId  String    @map("organization_id")
  configurationId String?   @map("configuration_id")
  
  eventId         String    @map("event_id")
  eventType       String    @map("event_type")
  severity        String
  category        String?
  
  format          String
  formattedEvent  String    @map("formatted_event")
  
  status          String    @default("pending") // pending, sent, failed, retrying
  retryCount      Int       @default(0) @map("retry_count")
  maxRetries      Int       @default(3) @map("max_retries")
  
  errorMessage    String?   @map("error_message")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  sentAt          DateTime? @map("sent_at")
  
  @@index([organizationId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([eventId])
  @@map("siem_event_log")
}
