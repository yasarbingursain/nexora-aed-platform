-- MalGenX Malware Analysis Schema
-- OCSF-Compliant: Category 4 (Security Finding), Class 4001 (Malware Finding)
-- Enterprise-grade malware sample tracking, analysis results, and IOC extraction
-- Multi-tenant with RLS, audit trails, and compliance mappings

CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- For fuzzy text search on IOCs

-- =============================================================================
-- MALWARE SAMPLES TABLE
-- =============================================================================
CREATE TABLE IF NOT EXISTS malware_samples (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Multi-tenancy
    organization_id         TEXT NOT NULL,
    
    -- Sample Identity
    submission_type         TEXT NOT NULL CHECK (submission_type IN ('file', 'url')),
    file_hash_sha256        TEXT,
    file_hash_md5           TEXT,
    file_hash_sha1          TEXT,
    file_name               TEXT,
    file_size_bytes         BIGINT,
    file_mime_type          TEXT,
    url                     TEXT,
    
    -- Submission Metadata
    source                  TEXT,
    tags                    TEXT[],
    priority                TEXT NOT NULL DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'critical')),
    submitted_by            TEXT,
    
    -- Analysis Status
    status                  TEXT NOT NULL DEFAULT 'queued' CHECK (status IN ('queued', 'analyzing', 'completed', 'failed', 'timeout')),
    analysis_started_at     TIMESTAMPTZ,
    analysis_completed_at   TIMESTAMPTZ,
    analysis_duration_ms    INTEGER,
    
    -- OCSF Classification
    category_uid            INTEGER NOT NULL DEFAULT 4,
    category_name           TEXT NOT NULL DEFAULT 'Security Finding',
    class_uid               INTEGER NOT NULL DEFAULT 4001,
    class_name              TEXT NOT NULL DEFAULT 'Malware Finding',
    type_uid                INTEGER NOT NULL DEFAULT 400101,
    type_name               TEXT NOT NULL DEFAULT 'Malware Sample Analysis',
    
    -- Risk Assessment
    risk_score              NUMERIC(5,2),
    risk_level              TEXT CHECK (risk_level IN ('low', 'medium', 'high', 'critical')),
    confidence_score        NUMERIC(3,2) CHECK (confidence_score IS NULL OR (confidence_score >= 0 AND confidence_score <= 1)),
    
    -- Malware Classification
    malware_family          TEXT,
    malware_category        TEXT, -- ransomware, trojan, worm, rootkit, spyware, adware, cryptominer, etc.
    is_malicious            BOOLEAN,
    false_positive          BOOLEAN DEFAULT FALSE,
    
    -- MITRE ATT&CK Mapping
    mitre_tactics           TEXT[], -- Initial Access, Execution, Persistence, etc.
    mitre_techniques        TEXT[], -- T1566, T1059, etc.
    
    -- Storage & Retention
    storage_location        TEXT, -- S3/blob path for sample file
    retention_policy        TEXT DEFAULT 'standard', -- standard, extended, permanent
    expires_at              TIMESTAMPTZ,
    
    -- Audit Fields
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    deleted_at              TIMESTAMPTZ,
    
    -- Constraints
    CONSTRAINT valid_risk_score CHECK (risk_score IS NULL OR (risk_score >= 0 AND risk_score <= 100)),
    CONSTRAINT file_or_url CHECK (
        (submission_type = 'file' AND file_hash_sha256 IS NOT NULL) OR
        (submission_type = 'url' AND url IS NOT NULL)
    )
);

-- =============================================================================
-- ANALYSIS RESULTS TABLE
-- =============================================================================
CREATE TABLE IF NOT EXISTS malware_analysis_results (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sample_id               UUID NOT NULL REFERENCES malware_samples(id) ON DELETE CASCADE,
    
    -- Analysis Engine Info
    engine_name             TEXT NOT NULL, -- sandbox, static_analyzer, ml_classifier, yara_scanner
    engine_version          TEXT,
    
    -- Static Analysis Results
    static_analysis         JSONB, -- PE headers, strings, imports, exports, sections, etc.
    
    -- Dynamic Analysis Results (Sandbox)
    dynamic_analysis        JSONB, -- process tree, network connections, file system changes, registry mods
    
    -- Behavioral Indicators
    behaviors               JSONB, -- suspicious behaviors detected
    
    -- Network Activity
    network_connections     JSONB, -- IPs, domains, URLs contacted
    dns_queries             TEXT[],
    http_requests           JSONB,
    
    -- File System Activity
    files_created           TEXT[],
    files_modified          TEXT[],
    files_deleted           TEXT[],
    
    -- Registry Activity (Windows)
    registry_keys_created   TEXT[],
    registry_keys_modified  TEXT[],
    registry_keys_deleted   TEXT[],
    
    -- Process Activity
    processes_created       JSONB,
    process_injections      JSONB,
    
    -- YARA Rule Matches
    yara_matches            JSONB,
    
    -- ML Model Predictions
    ml_predictions          JSONB, -- model name, version, prediction, confidence
    
    -- Signature Matches
    signature_matches       JSONB, -- AV signatures, custom signatures
    
    -- Screenshots/Artifacts
    screenshots             TEXT[], -- URLs to screenshots
    pcap_files              TEXT[], -- URLs to PCAP files
    memory_dumps            TEXT[], -- URLs to memory dumps
    
    -- Execution Metadata
    execution_time_seconds  INTEGER,
    timeout_occurred        BOOLEAN DEFAULT FALSE,
    errors                  JSONB,
    
    -- Audit Fields
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- EXTRACTED IOCs TABLE
-- =============================================================================
CREATE TABLE IF NOT EXISTS malware_iocs (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sample_id               UUID NOT NULL REFERENCES malware_samples(id) ON DELETE CASCADE,
    
    -- IOC Identity
    ioc_type                TEXT NOT NULL CHECK (ioc_type IN ('ipv4', 'ipv6', 'domain', 'url', 'hash', 'email', 'mutex', 'registry_key', 'file_path', 'user_agent')),
    ioc_value               TEXT NOT NULL,
    
    -- Context
    extraction_method       TEXT NOT NULL, -- static, dynamic, network, memory
    context                 TEXT, -- where/how it was found
    
    -- Validation
    is_validated            BOOLEAN DEFAULT FALSE,
    validation_method       TEXT, -- threat_intel_lookup, sandbox_confirmation, manual_review
    
    -- Threat Intel Enrichment
    threat_intel_sources    TEXT[], -- VirusTotal, AbuseIPDB, OTX, etc.
    reputation_score        NUMERIC(3,2),
    is_known_malicious      BOOLEAN,
    
    -- Geolocation (for IPs)
    country_code            TEXT,
    country_name            TEXT,
    asn                     TEXT,
    asn_org                 TEXT,
    
    -- Temporal
    first_seen              TIMESTAMPTZ NOT NULL DEFAULT now(),
    last_seen               TIMESTAMPTZ NOT NULL DEFAULT now(),
    
    -- Audit Fields
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    
    -- Unique constraint: one IOC per sample (but same IOC can appear in multiple samples)
    CONSTRAINT unique_sample_ioc UNIQUE (sample_id, ioc_type, ioc_value)
);

-- =============================================================================
-- MALWARE FAMILY SIGNATURES TABLE
-- =============================================================================
CREATE TABLE IF NOT EXISTS malware_signatures (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Signature Identity
    signature_name          TEXT NOT NULL UNIQUE,
    malware_family          TEXT NOT NULL,
    malware_category        TEXT NOT NULL,
    
    -- Signature Data
    yara_rule               TEXT,
    behavioral_patterns     JSONB,
    network_patterns        JSONB,
    file_patterns           JSONB,
    
    -- Metadata
    severity                TEXT NOT NULL CHECK (severity IN ('low', 'medium', 'high', 'critical')),
    confidence              NUMERIC(3,2) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
    description             TEXT,
    threat_references       TEXT[], -- URLs to threat reports
    
    -- MITRE ATT&CK
    mitre_tactics           TEXT[],
    mitre_techniques        TEXT[],
    
    -- Versioning
    version                 TEXT NOT NULL DEFAULT '1.0',
    is_active               BOOLEAN DEFAULT TRUE,
    
    -- Audit Fields
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =============================================================================
-- THREAT INTELLIGENCE FEED INTEGRATION
-- =============================================================================
CREATE TABLE IF NOT EXISTS malware_threat_intel (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- IOC Identity
    ioc_type                TEXT NOT NULL,
    ioc_value               TEXT NOT NULL,
    
    -- Source
    source                  TEXT NOT NULL, -- virustotal, abuseipdb, otx, misp, etc.
    source_confidence       NUMERIC(3,2),
    
    -- Classification
    malware_families        TEXT[],
    threat_categories       TEXT[],
    
    -- Risk Assessment
    risk_score              NUMERIC(5,2) NOT NULL,
    severity                TEXT NOT NULL CHECK (severity IN ('low', 'medium', 'high', 'critical')),
    
    -- Enrichment Data
    enrichment_data         JSONB,
    
    -- Temporal
    first_seen              TIMESTAMPTZ NOT NULL,
    last_seen               TIMESTAMPTZ NOT NULL,
    expires_at              TIMESTAMPTZ,
    
    -- Audit Fields
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    
    CONSTRAINT unique_source_ioc UNIQUE (source, ioc_type, ioc_value)
);

-- =============================================================================
-- INDEXES FOR PERFORMANCE
-- =============================================================================

-- Malware Samples Indexes
CREATE INDEX IF NOT EXISTS idx_malware_samples_org ON malware_samples (organization_id);
CREATE INDEX IF NOT EXISTS idx_malware_samples_status ON malware_samples (status);
CREATE INDEX IF NOT EXISTS idx_malware_samples_sha256 ON malware_samples (file_hash_sha256) WHERE file_hash_sha256 IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_malware_samples_md5 ON malware_samples (file_hash_md5) WHERE file_hash_md5 IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_malware_samples_url ON malware_samples (url) WHERE url IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_malware_samples_risk ON malware_samples (risk_score DESC) WHERE risk_score IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_malware_samples_family ON malware_samples (malware_family) WHERE malware_family IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_malware_samples_created ON malware_samples (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_malware_samples_tags ON malware_samples USING GIN (tags);
CREATE INDEX IF NOT EXISTS idx_malware_samples_mitre ON malware_samples USING GIN (mitre_techniques);

-- Analysis Results Indexes
CREATE INDEX IF NOT EXISTS idx_analysis_results_sample ON malware_analysis_results (sample_id);
CREATE INDEX IF NOT EXISTS idx_analysis_results_engine ON malware_analysis_results (engine_name);
CREATE INDEX IF NOT EXISTS idx_analysis_results_created ON malware_analysis_results (created_at DESC);

-- IOCs Indexes
CREATE INDEX IF NOT EXISTS idx_malware_iocs_sample ON malware_iocs (sample_id);
CREATE INDEX IF NOT EXISTS idx_malware_iocs_type ON malware_iocs (ioc_type);
CREATE INDEX IF NOT EXISTS idx_malware_iocs_value ON malware_iocs (ioc_value);
CREATE INDEX IF NOT EXISTS idx_malware_iocs_value_trgm ON malware_iocs USING GIN (ioc_value gin_trgm_ops);
CREATE INDEX IF NOT EXISTS idx_malware_iocs_validated ON malware_iocs (is_validated);
CREATE INDEX IF NOT EXISTS idx_malware_iocs_malicious ON malware_iocs (is_known_malicious) WHERE is_known_malicious = TRUE;

-- Signatures Indexes
CREATE INDEX IF NOT EXISTS idx_malware_signatures_family ON malware_signatures (malware_family);
CREATE INDEX IF NOT EXISTS idx_malware_signatures_category ON malware_signatures (malware_category);
CREATE INDEX IF NOT EXISTS idx_malware_signatures_active ON malware_signatures (is_active) WHERE is_active = TRUE;

-- Threat Intel Indexes
CREATE INDEX IF NOT EXISTS idx_threat_intel_ioc ON malware_threat_intel (ioc_type, ioc_value);
CREATE INDEX IF NOT EXISTS idx_threat_intel_source ON malware_threat_intel (source);
CREATE INDEX IF NOT EXISTS idx_threat_intel_risk ON malware_threat_intel (risk_score DESC);
CREATE INDEX IF NOT EXISTS idx_threat_intel_severity ON malware_threat_intel (severity);

-- =============================================================================
-- TRIGGERS FOR AUDIT TRAILS
-- =============================================================================

-- Update timestamp trigger for malware_samples
CREATE OR REPLACE FUNCTION update_malware_samples_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_malware_samples_updated_at
    BEFORE UPDATE ON malware_samples
    FOR EACH ROW
    EXECUTE FUNCTION update_malware_samples_updated_at();

-- Update timestamp trigger for malware_iocs
CREATE OR REPLACE FUNCTION update_malware_iocs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    NEW.last_seen = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_malware_iocs_updated_at
    BEFORE UPDATE ON malware_iocs
    FOR EACH ROW
    EXECUTE FUNCTION update_malware_iocs_updated_at();

-- =============================================================================
-- COMMENTS FOR DOCUMENTATION
-- =============================================================================

COMMENT ON TABLE malware_samples IS 'OCSF-compliant malware sample submissions and analysis tracking';
COMMENT ON TABLE malware_analysis_results IS 'Detailed analysis results from sandbox, static analysis, and ML engines';
COMMENT ON TABLE malware_iocs IS 'Indicators of Compromise extracted from malware samples';
COMMENT ON TABLE malware_signatures IS 'Malware family signatures for detection and classification';
COMMENT ON TABLE malware_threat_intel IS 'Threat intelligence feed data for IOC enrichment';

COMMENT ON COLUMN malware_samples.category_uid IS 'OCSF Category UID: 4 = Security Finding';
COMMENT ON COLUMN malware_samples.class_uid IS 'OCSF Class UID: 4001 = Malware Finding';
COMMENT ON COLUMN malware_samples.type_uid IS 'OCSF Type UID: 400101 = Malware Sample Analysis';
