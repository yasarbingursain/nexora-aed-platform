# Privilege Escalation Detection Rules
# Enterprise-grade detection for privilege escalation attempts

- name: scope_escalation_attempt
  description: "Entity requests scopes beyond baseline"
  severity: critical
  condition: "len(requested_scopes - baseline_scopes) > 0 and jaccard_distance(requested_scopes, baseline_scopes) > 0.5"
  action: deny
  enabled: true
  metadata:
    mitre_attack: ["T1078.004"]  # Valid Accounts: Cloud Accounts
    pci_dss: ["6.4.3", "7.1.1"]
    nist: ["AC-6", "AC-2"]
    tags: ["privilege_escalation", "scope_abuse"]
    confidence: 95

- name: token_lineage_break
  description: "Token parent_kid doesn't match mint path"
  severity: high
  condition: "token_parent_kid != expected_parent_from_mint_path"
  action: rotate_immediately
  enabled: true
  metadata:
    mitre_attack: ["T1550.001"]  # Use Alternate Authentication Material: Application Access Token
    pci_dss: ["8.2.1"]
    nist: ["IA-5"]
    tags: ["token_forgery", "authentication"]
    confidence: 90

- name: new_region_anomaly
  description: "First API call from new country in 90 days"
  severity: medium
  condition: "not_in_set(ip_country, historical_countries_90d) and entity_age_days > 7"
  action: step_up_auth
  enabled: true
  ttl_seconds: 86400  # 24 hours
  metadata:
    mitre_attack: ["T1535"]  # Unused/Unsupported Cloud Regions
    pci_dss: ["8.1.6"]
    nist: ["AC-7"]
    tags: ["geo_anomaly", "suspicious_location"]
    confidence: 75

- name: excessive_permission_usage
  description: "Entity uses more than 80% of granted permissions in short window"
  severity: high
  condition: "permission_usage_ratio > 0.8 and time_window_minutes < 15"
  action: notify
  enabled: true
  metadata:
    mitre_attack: ["T1078"]  # Valid Accounts
    pci_dss: ["7.1.2"]
    nist: ["AC-6"]
    tags: ["permission_abuse", "rapid_access"]
    confidence: 85

- name: cross_account_access_anomaly
  description: "Entity accesses resources in new account without baseline"
  severity: critical
  condition: "not_in_set(target_account, baseline_accounts) and is_cross_account"
  action: quarantine
  enabled: true
  ttl_seconds: 3600  # 1 hour
  metadata:
    mitre_attack: ["T1078.004"]
    pci_dss: ["7.2.1"]
    nist: ["AC-3"]
    tags: ["cross_account", "lateral_movement"]
    confidence: 90
