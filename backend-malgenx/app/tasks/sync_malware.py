"""
Background task to sync real malware data from MalwareBazaar
Uses MalwareBazaar API (abuse.ch) for enterprise-grade threat intelligence
"""
import asyncio
from datetime import datetime
import uuid
import logging
from sqlalchemy.orm import Session

from app.db.session import SessionLocal
from app.db.models import MalwareSample, MalwareIOC
from app.services.malwarebazaar import malwarebazaar_service

logger = logging.getLogger(__name__)

def calculate_risk_score(signature: str, file_type: str, tags: list) -> tuple:
    """Calculate risk score based on malware signature, file type, and tags"""
    risk_score = 0.5
    risk_level = "medium"
    
    if not signature:
        signature = ""
    
    signature_lower = signature.lower()
    
    # High-risk malware families
    high_risk_families = [
        "lockbit", "blackcat", "alphv", "conti", "ryuk", "revil", "sodinokibi",
        "trickbot", "emotet", "qakbot", "cobalt", "ransomware", "wannacry",
        "petya", "notpetya", "maze", "egregor", "darkside"
    ]
    
    # Critical malware types
    critical_types = ["ransomware", "backdoor", "trojan-banker", "rootkit"]
    
    signature_lower = signature.lower() if signature else ""
    tags_lower = [t.lower() for t in (tags or [])]
    
    # Check for high-risk families
    for family in high_risk_families:
        if family in signature_lower or any(family in tag for tag in tags_lower):
            risk_score = 0.95
            risk_level = "critical"
            break
    
    # Check for critical types
    for crit_type in critical_types:
        if crit_type in signature_lower or any(crit_type in tag for tag in tags_lower):
            risk_score = max(risk_score, 0.88)
            risk_level = "high" if risk_level != "critical" else "critical"
    
    # Adjust based on tags
    if "trojan" in tags_lower:
        risk_score = max(risk_score, 0.75)
        risk_level = "high" if risk_level not in ["critical"] else risk_level
    
    return risk_score, risk_level

async def sync_malware_from_bazaar():
    """Fetch and sync real malware samples from MalwareBazaar"""
    db = SessionLocal()
    
    try:
        logger.info("üîÑ Starting MalwareBazaar sync...")
        
        # Fetch recent samples from MalwareBazaar
        samples = await malwarebazaar_service.get_recent_samples(limit=50)
        
        if not samples:
            logger.warning("No samples fetched from MalwareBazaar")
            return
        
        synced_count = 0
        
        for sample_data in samples:
            try:
                sha256_hash = sample_data.get("sha256_hash")
                
                if not sha256_hash:
                    continue
                
                # Check if already exists
                existing = db.query(MalwareSample).filter(
                    MalwareSample.file_name == sha256_hash
                ).first()
                
                if existing:
                    continue
                
                # Extract metadata
                signature = sample_data.get("signature") or "Unknown Malware"
                file_type = sample_data.get("file_type", "unknown")
                file_name = sample_data.get("file_name", "unknown")
                tags = sample_data.get("tags", [])
                
                # If no signature, try to extract from file name or tags
                if signature == "Unknown Malware" and tags:
                    signature = tags[0].upper() if tags else "Generic Malware"
                
                # Calculate risk
                risk_score, risk_level = calculate_risk_score(signature, file_type, tags)
                
                # Determine malware category from signature
                malware_category = "Malware"
                sig_lower = signature.lower() if signature else ""
                
                if "ransomware" in sig_lower or "ransom" in sig_lower:
                    malware_category = "Ransomware"
                elif "trojan" in sig_lower:
                    malware_category = "Trojan"
                elif "backdoor" in sig_lower:
                    malware_category = "Backdoor"
                elif "spyware" in sig_lower or "stealer" in sig_lower:
                    malware_category = "Spyware"
                elif "miner" in sig_lower or "cryptominer" in sig_lower:
                    malware_category = "Cryptominer"
                elif "worm" in sig_lower:
                    malware_category = "Worm"
                elif "rootkit" in sig_lower:
                    malware_category = "Rootkit"
                
                # Parse dates
                first_seen = sample_data.get("first_seen")
                created_at = datetime.utcnow()
                if first_seen:
                    try:
                        created_at = datetime.fromisoformat(first_seen.replace("Z", "+00:00"))
                    except:
                        pass
                
                # Create sample record
                sample = MalwareSample(
                    id=uuid.uuid4(),
                    organization_id="public",
                    submission_type="file",
                    file_name=file_name,
                    file_hash_sha256=sha256_hash,
                    file_hash_md5=sample_data.get("md5_hash"),
                    file_hash_sha1=sample_data.get("sha1_hash"),
                    file_mime_type=file_type,
                    file_size_bytes=sample_data.get("file_size"),
                    source="MalwareBazaar",
                    tags=tags,
                    priority="high" if risk_level in ["high", "critical"] else "normal",
                    status="completed",
                    is_malicious=True,
                    risk_score=risk_score,
                    risk_level=risk_level,
                    malware_family=signature,
                    malware_category=malware_category,
                    created_at=created_at,
                    updated_at=datetime.utcnow(),
                )
                
                db.add(sample)
                db.flush()  # Flush to get the sample ID before adding IOCs
                synced_count += 1
                
                # Add hash IOCs
                for hash_type, hash_value in [
                    ("sha256", sample_data.get("sha256_hash")),
                    ("md5", sample_data.get("md5_hash")),
                    ("sha1", sample_data.get("sha1_hash"))
                ]:
                    if hash_value:
                        ioc = MalwareIOC(
                            id=uuid.uuid4(),
                            sample_id=sample.id,
                            organization_id="public",
                            ioc_type="hash",
                            ioc_value=hash_value,
                            extraction_method="malwarebazaar_api",
                            is_validated=True,
                            is_known_malicious=True,
                            reputation_score=risk_score,
                            first_seen=created_at,
                            last_seen=datetime.utcnow(),
                            created_at=created_at,
                            updated_at=datetime.utcnow(),
                        )
                        db.add(ioc)
                
            except Exception as e:
                logger.error(f"Error processing sample {sample_data.get('sha256_hash')}: {e}")
                continue
        
        db.commit()
        logger.info(f"‚úÖ Synced {synced_count} new malware samples from MalwareBazaar")
        
    except Exception as e:
        logger.error(f"‚ùå Error in MalwareBazaar sync: {e}")
        db.rollback()
    finally:
        db.close()

def run_sync():
    """Run sync in asyncio event loop"""
    asyncio.run(sync_malware_from_bazaar())

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    run_sync()
