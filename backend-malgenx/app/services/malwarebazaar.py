"""
MalwareBazaar Integration Service
Fetches real-time malware samples from MalwareBazaar API (abuse.ch)
Enterprise-grade threat intelligence with proper authentication
"""
import httpx
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import logging

logger = logging.getLogger(__name__)

MALWAREBAZAAR_API = "https://mb-api.abuse.ch/api/v1/"
# MalwareBazaar API key - FREE registration at https://bazaar.abuse.ch/api/
# IMPORTANT: Register for a free API key to access real-time malware samples
# Without API key, the service will return empty results
MALWAREBAZAAR_API_KEY = "75f061638f5d2ec754c11ccb6c2ebaf967a2bb95d409fa87"

class MalwareBazaarService:
    """Service to fetch real-time malware samples from MalwareBazaar"""
    
    def __init__(self, api_key: str = MALWAREBAZAAR_API_KEY):
        self.api_url = MALWAREBAZAAR_API
        self.api_key = api_key
        
    async def get_recent_samples(self, limit: int = 100) -> List[Dict]:
        """
        Fetch recent malware samples from MalwareBazaar
        Returns real-time malware samples with hashes, signatures, and metadata
        """
        try:
            async with httpx.AsyncClient(timeout=30.0) as client:
                # Prepare headers with Auth-Key if available
                headers = {}
                if self.api_key:
                    headers["Auth-Key"] = self.api_key
                
                # Query recent samples (last 100 additions)
                response = await client.post(
                    self.api_url,
                    data={
                        "query": "get_recent",
                        "selector": "100"  # Get last 100 samples
                    },
                    headers=headers
                )
                
                if response.status_code != 200:
                    logger.error(f"MalwareBazaar API error: {response.status_code}")
                    return []
                
                data = response.json()
                
                if data.get("query_status") != "ok":
                    logger.error(f"MalwareBazaar query failed: {data.get('query_status')}")
                    return []
                
                samples = data.get("data", [])[:limit]
                
                # Transform to our format
                transformed = []
                for sample in samples:
                    # Extract key information
                    sha256_hash = sample.get("sha256_hash", "")
                    signature = sample.get("signature")
                    file_type = sample.get("file_type", "unknown")
                    file_name = sample.get("file_name", "unknown")
                    tags = sample.get("tags", []) if sample.get("tags") else []
                    
                    transformed.append({
                        "sha256_hash": sha256_hash,
                        "md5_hash": sample.get("md5_hash"),
                        "sha1_hash": sample.get("sha1_hash"),
                        "signature": signature,
                        "file_type": file_type,
                        "file_name": file_name,
                        "file_size": sample.get("file_size"),
                        "first_seen": sample.get("first_seen"),
                        "last_seen": sample.get("last_seen"),
                        "reporter": sample.get("reporter"),
                        "origin_country": sample.get("origin_country"),
                        "tags": tags,
                        "intelligence": sample.get("intelligence", {}),
                    })
                
                logger.info(f"âœ… Fetched {len(transformed)} real malware samples from MalwareBazaar")
                return transformed
                
        except Exception as e:
            logger.error(f"Error fetching from MalwareBazaar: {e}")
            return []
    
    async def query_hash(self, hash_value: str) -> Optional[Dict]:
        """
        Query MalwareBazaar for a specific hash
        Uses proper Auth-Key header as per API documentation
        """
        try:
            async with httpx.AsyncClient(timeout=30.0) as client:
                # Prepare headers with Auth-Key if available
                headers = {}
                if self.api_key:
                    headers["Auth-Key"] = self.api_key
                
                response = await client.post(
                    self.api_url,
                    data={
                        "query": "get_info",
                        "hash": hash_value
                    },
                    headers=headers
                )
                
                if response.status_code != 200:
                    logger.error(f"MalwareBazaar hash query error: {response.status_code}")
                    return None
                
                data = response.json()
                
                if data.get("query_status") != "ok":
                    logger.warning(f"Hash not found or query failed: {hash_value}")
                    return None
                
                return data.get("data", [{}])[0] if data.get("data") else None
                
        except Exception as e:
            logger.error(f"Error querying hash from MalwareBazaar: {e}")
            return None

# Singleton instance
malwarebazaar_service = MalwareBazaarService()
